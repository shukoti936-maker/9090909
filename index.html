<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ¡å›­åŠ©æ‰‹ Pro - å®Œç¾ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f3f4f6; margin: 0; padding-bottom: 50px; }
        .header { background: white; padding: 15px; text-align: center; font-weight: bold; color: #4f46e5; position: sticky; top: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;}
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .tabs { display: flex; justify-content: space-around; background: white; padding: 10px; margin-bottom: 15px; }
        .tab { padding: 8px 15px; border-radius: 20px; color: #666; font-size: 0.9rem; cursor: pointer; }
        .tab.active { background: #4f46e5; color: white; font-weight: bold; }

        /* å†…å®¹åŒº */
        .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .btn-main { width: 100%; background: #4f46e5; color: white; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; margin-bottom: 20px; cursor: pointer; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .price { color: #dc2626; font-weight: bold; font-size: 1.2rem; }
        .contact { background: #f3f4f6; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem; color: #555; margin: 5px 0; display: inline-block;}
        
        /* å›¾ç‰‡å±•ç¤ºåŒº */
        .img-box { margin-top: 10px; }
        .main-img { width: 100%; border-radius: 8px; object-fit: cover; max-height: 300px; display: block; margin-bottom: 10px; }
        .pay-box { border: 1px dashed #ef4444; background: #fef2f2; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .pay-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .pay-text { font-size: 0.8rem; color: #ef4444; }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; padding: 20px; border-radius: 20px 20px 0 0; box-sizing: border-box; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }
        
        input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* ä¸Šä¼ æŒ‰é’®ç¾åŒ– */
        .upload-area { border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 10px; position: relative; }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .blue-area { border-color: #4f46e5; background: #eef2ff; color: #4f46e5; }
        .red-area { border-color: #ef4444; background: #fef2f2; color: #ef4444; }

    </style>
</head>
<body>

<div class="header">æ ¡å›­åŠ©æ‰‹ PRO</div>

<div class="tabs">
    <div class="tab active" onclick="setCat('market', this)">äºŒæ‰‹</div>
    <div class="tab" onclick="setCat('carpool', this)">æ‹¼è½¦</div>
    <div class="tab" onclick="setCat('jobs', this)">å…¼èŒ</div>
</div>

<div class="container">
    <button class="btn-main" onclick="openModal()">+ å‘å¸ƒæ–°æ¶ˆæ¯</button>
    <div id="list">åŠ è½½ä¸­...</div>
</div>

<div class="modal" id="pubModal">
    <div class="modal-content">
        <h3>å‘å¸ƒåŠ¨æ€</h3>
        <input type="text" id="title" placeholder="æ ‡é¢˜ (ä¾‹å¦‚: å‡º99æ–°iPad)">
        <input type="text" id="price" placeholder="ä»·æ ¼ (ä¾‹å¦‚: 2000)">
        <input type="text" id="contact" placeholder="è”ç³»æ–¹å¼ (å¾®ä¿¡/æ‰‹æœº)">
        
        <div class="upload-area blue-area">
            <span>ğŸ“¸ ç‚¹å‡»ä¸Šä¼ ç‰©å“ç…§ç‰‡</span>
            <input type="file" id="fileItem" accept="image/*">
        </div>

        <div class="upload-area red-area">
            <span>ğŸ’° ç‚¹å‡»ä¸Šä¼ æ”¶æ¬¾ç  (å¯é€‰)</span>
            <input type="file" id="filePay" accept="image/*">
        </div>

        <button class="btn-main" id="subBtn" onclick="submitData()">ç¡®è®¤å‘å¸ƒ</button>
        <button style="width:100%; border:none; background:none; color:#888;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- ğŸ”´ ç¬¬ä¸€æ­¥ï¼šæŠŠä½ çš„é’¥åŒ™å¡«åœ¨è¿™é‡Œ (å¿…é¡»æ”¾åœ¨æœ€å‰é¢) ---
    // åƒä¸‡ä¸è¦å¡«åäº†ï¼S_URL æ˜¯çŸ­çš„é‚£ä¸ªç½‘å€ï¼ŒS_KEY æ˜¯å¾ˆé•¿çš„é‚£ä¸²ä¹±ç 
    const S_URL = 'https://shukoti936-maker.github.io/campus-life/';
    const S_KEY = 'yJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlZmRlYWFveXpkdGpydHhrbnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODYxNTAsImV4cCI6MjA4NjM2MjE1MH0.t8DzJGmPA8d1j-EnlPiwRcvBwVpAm1_03R9fGnHsSTg';
    
    // --- ğŸ”µ åˆå§‹åŒ–å®¢æˆ·ç«¯ (è¿™è¡Œä»£ç å¿…é¡»åœ¨ä¸Šé¢å®šä¹‰å®Œ URL å’Œ KEY ä¹‹å) ---
    const client = supabase.createClient(S_URL, S_KEY);
    let curCat = 'market';

    // åˆ‡æ¢åˆ†ç±»
    function setCat(cat, el) {
        curCat = cat;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        loadList();
    }

    // åŠ è½½åˆ—è¡¨
    async function loadList() {
        document.getElementById('list').innerHTML = 'åŠ è½½ä¸­...';
        // æŸ¥è¯¢æ•°æ®åº“
        const { data, error } = await client
            .from('items') // ç¡®ä¿ä½ è¡¨åæ˜¯ items
            .select('*')
            .eq('category', curCat)
            .order('id', { ascending: false });

        if (error) {
            console.error(error);
            document.getElementById('list').innerHTML = '<p style="color:red;text-align:center">æ•°æ®åº“è¿æ¥å¤±è´¥<br>è¯·æ£€æŸ¥ï¼š1.è¡¨åæ˜¯å¦å«items 2.RLSæ˜¯å¦å…³é—­ 3.åˆ—æ˜¯å¦å»ºå…¨äº†</p>';
            return;
        }

        if (!data || data.length === 0) {
            document.getElementById('list').innerHTML = '<p style="text-align:center;color:#999">æš‚æ— ä¿¡æ¯ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
            return;
        }

        let html = '';
        data.forEach(item => {
            html += `
                <div class="card">
                    <h3>${item.title}</h3>
                    <div class="price">Â¥ ${item.price}</div>
                    <div class="contact">è”ç³»ï¼š${item.contact}</div>
                    
                    <div class="img-box">
                        ${item.image_url ? `<img src="${item.image_url}" class="main-img">` : ''}
                        
                        ${item.pay_url ? `
                            <div class="pay-box" onclick="window.open('${item.pay_url}')">
                                <img src="${item.pay_url}" class="pay-img">
                                <span class="pay-text">â¬…ï¸ ç‚¹å›¾é•¿æŒ‰è¯†åˆ«ä»˜æ¬¾</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        document.getElementById('list').innerHTML = html;
    }

    // ä¸Šä¼ å›¾ç‰‡å‡½æ•°
    async function uploadImg(file) {
        if (!file) return "";
        // æ–‡ä»¶ååŠ éšæœºæ•°é˜²æ­¢é‡å¤
        const name = Date.now() + '_' + Math.floor(Math.random()*1000) + '.jpg';
        // ä¸Šä¼ åˆ° images æ¡¶
        const { data, error } = await client.storage.from('images').upload(name, file);
        if (error) throw error;
        // è·å–å…¬å¼€é“¾æ¥
        const { data: urlData } = client.storage.from('images').getPublicUrl(name);
        return urlData.publicUrl;
    }

    // æäº¤æ•°æ®
    async function submitData() {
        const btn = document.getElementById('subBtn');
        const title = document.getElementById('title').value;
        const price = document.getElementById('price').value;
        const contact = document.getElementById('contact').value;
        const fileItem = document.getElementById('fileItem').files[0];
        const filePay = document.getElementById('filePay').files[0];

        if (!title || !price || !contact) return alert('æ ‡é¢˜ã€ä»·æ ¼ã€è”ç³»æ–¹å¼å¿…å¡«ï¼');

        btn.disabled = true;
        btn.innerText = 'æ­£åœ¨ä¸Šä¼ ...';

        try {
            // å¹¶è¡Œä¸Šä¼ ä¸¤å¼ å›¾
            const [imgUrl, payUrl] = await Promise.all([
                uploadImg(fileItem),
                uploadImg(filePay)
            ]);

            // å†™å…¥æ•°æ®åº“ (æ³¨æ„ï¼šè¿™é‡Œè¦æœ‰ pay_url åˆ—æ‰èƒ½æˆåŠŸ)
            const { error } = await client.from('items').insert({
                title: title,
                price: price,
                contact: contact,
                category: curCat,
                image_url: imgUrl,
                pay_url: payUrl
            });

            if (error) throw error;

            alert('å‘å¸ƒæˆåŠŸï¼');
            closeModal();
            loadList();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('title').value = '';
            document.getElementById('price').value = '';
            
        } catch (err) {
            alert('å‘å¸ƒå¤±è´¥ï¼š' + err.message + '\n(å¦‚æœæ˜¯ Column not foundï¼Œè¯·å»Supabaseå¢åŠ åˆ—)');
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = 'ç¡®è®¤å‘å¸ƒ';
        }
    }

    function openModal() { document.getElementById('pubModal').classList.add('show'); }
    function closeModal() { document.getElementById('pubModal').classList.remove('show'); }

    // å¯åŠ¨åŠ è½½
    loadList();
</script>

</body>
</html>
